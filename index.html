<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Museum Object Record Comparator ‚Äî Dual Catalogue Edition</title>

  <!-- Bootstrap + DataTables CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      background-color: #fafafa;
      font-family: 'Inter', sans-serif;
      margin: 1.5rem;
    }

    h1 {
      text-align: center;
      margin-bottom: 1rem;
      font-weight: 600;
    }

    .dual-panel {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
    }

    .panel {
      flex: 1 1 45%;
      background: #fff;
      border-radius: 10px;
      padding: 1.2rem;
      box-shadow: 0 0 8px rgba(0,0,0,0.05);
      min-width: 280px;
    }

    .panel h5, .panel h6 {
      border-bottom: 2px solid #007bff33;
      padding-bottom: .5rem;
      margin-bottom: 1rem;
      font-weight: 600;
    }

    .field-row {
      border-bottom: 1px dashed #eee;
      padding: .25rem 0;
      font-size: .95rem;
      display: flex;
      justify-content: space-between;
    }

    .field-row strong {
      width: 40%;
      color: #333;
      word-break: break-word;
    }

    /* DataTables catalogue label */
    .catalogue-badge {
      padding: 3px 8px;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
      color: #fff;
    }
    .badge-A { background-color: #0d6efd; }
    .badge-B { background-color: #6610f2; }

    /* Harmful/outdated language box */
    .harm-block {
      background: #fff5f5;
      border: 1px solid #ffcccc;
      padding: 1rem;
      border-radius: 8px;
      margin-top: 1rem;
    }
    .outdated-block {
      background: #fffdf2;
      border: 1px solid #f5e7a1;
      padding: 1rem;
      border-radius: 8px;
      margin-top: 1rem;
    }

    footer {
      text-align: center;
      font-size: .9rem;
      margin-top: 2rem;
      color: #777;
    }

    @media (max-width: 768px) {
      .dual-panel { flex-direction: column; }
      .panel { flex: 1 1 100%; }
    }
  </style>
</head>

<body>
  <div class="container">

    <h1>üß≠ Museum Object Record Comparator ‚Äî Dual Catalogue Edition</h1>

    <p class="text-center text-muted mb-3">
      Compare entries across <b>Catalogue A</b> and <b>Catalogue B</b> with unified search, schema insights, and harmful/outdated language analysis.
    </p>

    <!-- ============================= -->
    <!-- CATALOGUE SELECTOR UI SECTION -->
    <!-- ============================= -->
    <div class="d-flex justify-content-center mb-3">
      <div class="btn-group" role="group" aria-label="Catalogue Filter">
        <input type="radio" class="btn-check" name="catalogueSelect" id="catA" value="A" autocomplete="off">
        <label class="btn btn-outline-primary" for="catA">Catalogue A</label>

        <input type="radio" class="btn-check" name="catalogueSelect" id="catB" value="B" autocomplete="off">
        <label class="btn btn-outline-primary" for="catB">Catalogue B</label>

        <input type="radio" class="btn-check" name="catalogueSelect" id="catBoth" value="Both" autocomplete="off" checked>
        <label class="btn btn-outline-primary" for="catBoth">Both</label>
      </div>
    </div>

    <!-- GLOBAL SEARCH BAR -->
    <div class="mb-3 d-flex justify-content-center">
      <input type="text" id="globalSearch" class="form-control w-50" placeholder="üîç Search all records...">
    </div>

    <!-- MAIN TABLE -->
    <div class="table-responsive">
      <table id="recordsTable" class="table table-striped table-hover" style="width:100%">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>

    <footer>Built on the third-floor.</footer>
  </div>
<!-- ===================== -->
<!-- REQUIRED JS LIBRARIES -->
<!-- ===================== -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
// ---------------------------------------------
// SAFE JSON PARSER
// ---------------------------------------------
function safeParse(val) {
  if (!val) return null;
  val = String(val).trim();
  try { return JSON.parse(val); } catch(e) {}

  // Convert common Python-like dicts to JSON
  try {
    let fixed = val
      .replace(/'/g, '"')
      .replace(/\bNone\b/g, 'null')
      .replace(/\bTrue\b/g, 'true')
      .replace(/\bFalse\b/g, 'false');
    return JSON.parse(fixed);
  } catch (err) {
    return null;
  }
}

// Count entries for schema fields
function countValue(val) {
  if (!val) return 0;
  const parsed = safeParse(val);
  if (Array.isArray(parsed)) return parsed.length;
  if (typeof parsed === "object" && parsed !== null) return 1;
  return 1;
}

// ---------------------------------------------
// GLOBAL STORAGE
// ---------------------------------------------
let catalogueA = [];
let catalogueB = [];

let comparisonA = [];
let comparisonB = [];

let schemaA = [];
let schemaB = [];

let unifiedDataset = [];

let comparisonLookup = {};
let schemaLookup = {};

let harmfulTotals = {
  harmful: 0,
  harmfulTerms: [],
  outdated: 0,
  outdatedTerms: []
};

// ---------------------------------------------
// CSV LOADER
// ---------------------------------------------
function loadCSV(path) {
  return new Promise(resolve => {
    Papa.parse(path, {
      download: true,
      header: true,
      complete: (results) => {
        const cleaned = results.data.filter(r =>
          Object.keys(r).length > 1 &&
          Object.values(r).some(v => v !== "" && v !== null && v !== undefined)
        );
        resolve(cleaned);
      }
    });
  });
}

// ---------------------------------------------
// LOAD ALL CSVs THEN INITIALIZE INTERFACE
// ---------------------------------------------
document.addEventListener("DOMContentLoaded", async () => {

  console.log("üìÇ Loading Catalogue A and B CSVs‚Ä¶");

  // Load Catalogue A files
  [
    catalogueA,
    comparisonA,
    schemaA
  ] = await Promise.all([
    loadCSV("matched_records_1.csv"),
    loadCSV("entity_comparison_results_1.csv"),
    loadCSV("schema_extraction_1.csv")
  ]);

  // Load Catalogue B files
  [
    catalogueB,
    comparisonB,
    schemaB
  ] = await Promise.all([
    loadCSV("matched_records_2.csv"),
    loadCSV("entity_comparison_results_2.csv"),
    loadCSV("schema_extraction_2.csv")
  ]);

  console.log("‚úî CSVs loaded");

  // ---------------------------------------------
  // BUILD LOOKUP TABLES
  // ---------------------------------------------
  comparisonLookup["A"] = {};
  comparisonLookup["B"] = {};

  comparisonA.forEach(r => {
    const idx = Number(r.RowIndex);
    if (!isNaN(idx)) comparisonLookup["A"][idx] = r;
  });

  comparisonB.forEach(r => {
    const idx = Number(r.RowIndex);
    if (!isNaN(idx)) comparisonLookup["B"][idx] = r;
  });

  schemaLookup["A"] = {};
  schemaLookup["B"] = {};

  schemaA.forEach(r => {
    const idx = Number(r.RowIndex);
    if (!isNaN(idx)) schemaLookup["A"][idx] = r;
  });

  schemaB.forEach(r => {
    const idx = Number(r.RowIndex);
    if (!isNaN(idx)) schemaLookup["B"][idx] = r;
  });

  // ---------------------------------------------
  // MERGE INTO unifiedDataset
  // ---------------------------------------------
  unifiedDataset = [];

  catalogueA.forEach((row, i) => {
    unifiedDataset.push({ ...row, __cat: "A", __rowIndex: i });
  });

  catalogueB.forEach((row, i) => {
    unifiedDataset.push({ ...row, __cat: "B", __rowIndex: i });
  });

  console.log("Unified dataset constructed:", unifiedDataset.length, "rows");

  // ---------------------------------------------
  // COMPUTE GLOBAL HARMFUL / OUTDATED TOTALS
  // ---------------------------------------------
  function accumulateHarmful(schemaRows) {
    schemaRows.forEach(r => {
      const harmful = safeParse(r.harmful_language);
      const outdated = safeParse(r.outdated_language);

      if (harmful && harmful.count > 0) {
        harmfulTotals.harmful += harmful.count;
        harmfulTotals.harmfulTerms.push(...harmful.terms);
      }
      if (outdated && outdated.count > 0) {
        harmfulTotals.outdated += outdated.count;
        harmfulTotals.outdatedTerms.push(...outdated.terms);
      }
    });
  }

  accumulateHarmful(schemaA);
  accumulateHarmful(schemaB);

  console.log("Harmful totals:", harmfulTotals);

  // ---------------------------------------------
  // NOW THAT ALL DATA IS READY ‚Üí INITIALIZE UI
  // ---------------------------------------------
  createDataTable();
  setupCatalogueFiltering();
  setupSearchBar();

  console.log("‚úî Table initialized after CSV load");
});
</script>
<script>
// ==========================================================
// ===============   DATATABLE INITIALIZATION   =============
// ==========================================================

let recordsTable = null;

// ---------------------------------------------
// DEFINE visible columns for DataTables
// ---------------------------------------------
const VISIBLE_COLS = [
  "Catalogue number",
  "Object name",
  "Object/Inventory number",
  "uid",
  "identifier",
  "title"
];


// ---------------------------------------------
// CREATE THE DATATABLE
// ---------------------------------------------
function createDataTable() {

  // Determine which visible columns actually exist in dataset
  const sample = unifiedDataset[0] || {};
  const columns = VISIBLE_COLS.filter(col => col in sample).map(col => ({
      title: col,
      data: col
  }));

  // Add catalogue column
  columns.unshift({
    title: "Catalogue",
    data: "__cat",
    render: (cat) => {
      if (cat === "A") return `<span class="catalogue-badge badge-A">A</span>`;
      if (cat === "B") return `<span class="catalogue-badge badge-B">B</span>`;
      return cat;
    }
  });

  // Build the DataTable
  recordsTable = $("#recordsTable").DataTable({
    data: unifiedDataset,
    columns,
    pageLength: 25,
    responsive: true
  });

  // Row click handler ‚Üí modal (handled in chunk 4)
}


// ---------------------------------------------
// CATALOGUE FILTERING (A / B / Both)
// ---------------------------------------------
function setupCatalogueFiltering() {
  $("input[name='catalogueSelect']").on("change", function() {
    applyCatalogueFilter(this.value);
  });

  // Default selection
  applyCatalogueFilter("Both");
}

function applyCatalogueFilter(mode) {
  if (!recordsTable) return;

  recordsTable.column(0).search(""); // Reset first

  if (mode === "A") {
    recordsTable.column(0).search("^A$", true, false).draw();
  }
  else if (mode === "B") {
    recordsTable.column(0).search("^B$", true, false).draw();
  }
  else {
    // BOTH
    recordsTable.column(0).search("").draw();
  }
}


// ---------------------------------------------
// GLOBAL SEARCH BAR
// ---------------------------------------------
function setupSearchBar() {
  $("#globalSearch").on("keyup", function() {
    if (recordsTable) recordsTable.search(this.value).draw();
  });
}


// ---------------------------------------------
// TABLE ROW CLICK ‚Üí open modal viewer
// Will be implemented in Chunk 4
// ---------------------------------------------
$(document).on("click", "#recordsTable tbody tr", function () {
  const rowData = recordsTable.row(this).data();
  if (!rowData) return;

  openRecordModal(rowData); // Defined in Chunk 4
});
</script>
<script>
// ==========================================================
// ===============   RECORD MODAL GENERATION   ==============
// ==========================================================

let activeComparisonChart = null;

// ---------------------------------------------
// OPEN RECORD MODAL
// ---------------------------------------------
function openRecordModal(rowData) {

  const catalogue = rowData.__cat;       // "A" or "B"
  const rowIndex = rowData.__rowIndex;   // index within that catalogue

  // Lookup comparison + schema rows
  const comp = comparisonLookup[catalogue][rowIndex] || null;

  // Remove old modal if exists
  $("#recordModal").remove();

  buildModalShell();
  fillLeftRightPanels(rowData);
  fillUniqueSections(comp);
  buildComparisonChart(comp);
  setupImageViewer(rowData);

  // Schema + Harmful module added from Chunk 5
  const m = new bootstrap.Modal(document.getElementById("recordModal"));
  m.show();
}


// ---------------------------------------------
// BUILD MODAL SHELL
// ---------------------------------------------
function buildModalShell() {

  const html = `
  <div class="modal fade" id="recordModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">

        <div class="modal-header">
          <h5 class="modal-title">üîé Record Details</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">

          <!-- Comparison Radar Chart -->
          <div id="comparisonChartContainer" class="text-center mb-4">
            <canvas id="comparisonChart" style="max-width:600px;"></canvas>
            <button id="downloadComparisonChart" class="btn btn-outline-secondary btn-sm mt-2">
              ‚¨áÔ∏è Download Comparison Chart
            </button>
          </div>

          <!-- Dual Panels -->
          <div id="dualPanels" class="dual-panel mb-4"></div>

          <!-- Unique Sections -->
          <div class="dual-panel mb-4">
            <div class="panel">
              <h6>üåø Unique to Catalogue A</h6>
              <div id="uniqueA"></div>
            </div>
            <div class="panel">
              <h6>üè∫ Unique to Catalogue B</h6>
              <div id="uniqueB"></div>
            </div>
          </div>

          <!-- Schema + Harmful Sections -->
          <div id="schemaAndHarm"></div>

          <!-- Image -->
          <div class="mt-4 text-center">
            <h6>üñºÔ∏è Related Image</h6>
            <img id="recordImage"
                 src=""
                 class="img-fluid rounded shadow-sm"
                 style="max-height:420px; cursor:pointer;">
          </div>

        </div>

      </div>
    </div>
  </div>
  `;

  document.body.insertAdjacentHTML("beforeend", html);
}



// ---------------------------------------------
// LEFT / RIGHT PANELS
// ---------------------------------------------
const LEFT_FIELDS = [
  "Filename", "Catalogue number", "Object name", "Maker/Donor",
  "Date of creation", "Object entry information", "Object/Inventory number"
];

const RIGHT_FIELDS = [
  "uid","identifier","title","description","category",
  "material","object_name","date","place","maker","image"
];

function fillLeftRightPanels(rowData) {
  let leftHTML = `<div class="panel"><h5>üìò Catalogue ${rowData.__cat}</h5>`;
  LEFT_FIELDS.forEach(f => {
    if (rowData[f] !== undefined) {
      leftHTML += `<div class="field-row"><strong>${f}</strong><span>${rowData[f] || ""}</span></div>`;
    }
  });
  leftHTML += `</div>`;

  let rightHTML = `<div class="panel"><h5>üèõÔ∏è Online Record</h5>`;
  RIGHT_FIELDS.forEach(f => {
    if (rowData[f] !== undefined) {
      let v = rowData[f] || "";
      if (f === "uid" && v) v = `<a href="https://collection.sciencemuseumgroup.org.uk/objects/${v}" target="_blank">${v}</a>`;
      if (f === "image" && v) v = `<a href="https://coimages.sciencemuseumgroup.org.uk/${v}" target="_blank">View image üîó</a>`;
      rightHTML += `<div class="field-row"><strong>${f}</strong><span>${v}</span></div>`;
    }
  });
  rightHTML += `</div>`;

  $("#dualPanels").html(leftHTML + rightHTML);
}



// =====================================================================
// =========  FULLY CORRECTED UNIQUE FIELD LOGIC (Exact Names) =========
// =====================================================================

function makeUniqueBlock(str) {
  if (!str) return "<p class='text-muted'>None</p>";

  try {
    const obj = JSON.parse(str);
    let block = "";
    for (const [key, arr] of Object.entries(obj)) {
      if (Array.isArray(arr) && arr.length) {
        block += `<div><strong>${key}:</strong> ${arr.join(", ")}</div>`;
      }
    }
    return block || "<p class='text-muted'>None</p>";
  } catch {
    return "<p class='text-muted'>None</p>";
  }
}

function fillUniqueSections(comp) {

  if (!comp) {
    $("#uniqueA").html("<p class='text-muted'>None</p>");
    $("#uniqueB").html("<p class='text-muted'>None</p>");
    return;
  }

  // Your exact unique column names:
  const uniqueA = comp["Unique_to_Old"];
  const uniqueB = comp["Unique_to_New"];

  $("#uniqueA").html(makeUniqueBlock(uniqueA));
  $("#uniqueB").html(makeUniqueBlock(uniqueB));
}



// =====================================================================
// ===================== CORRECTED COMPARISON CHART ====================
// =====================================================================

const METRIC_LABELS = [
  "ObjectNames",
  "Makers",
  "Organisations/Institutions",
  "Dates",
  "Places",
  "Descriptions",
  "Other"
];

function metricToOldColumn(metric) { return "Old_" + metric; }
function metricToNewColumn(metric) { return "New_" + metric; }

function buildComparisonChart(comp) {
  if (!comp) return;

  const oldVals = METRIC_LABELS.map(m => Number(comp[metricToOldColumn(m)] || 0));
  const newVals = METRIC_LABELS.map(m => Number(comp[metricToNewColumn(m)] || 0));

  const maxVal = Math.max(...oldVals, ...newVals, 1);

  const ctx = document.getElementById("comparisonChart");
  if (activeComparisonChart) activeComparisonChart.destroy();

  activeComparisonChart = new Chart(ctx, {
    type: "radar",
    data: {
      labels: METRIC_LABELS,
      datasets: [
        {
          label: "Catalogue (Old)",
          data: oldVals,
          backgroundColor: "rgba(54,162,235,0.25)",
          borderColor: "rgba(54,162,235,1)"
        },
        {
          label: "Online (New)",
          data: newVals,
          backgroundColor: "rgba(255,99,132,0.25)",
          borderColor: "rgba(255,99,132,1)"
        }
      ]
    },
    options: {
      scales: { r: { beginAtZero: true, max: maxVal + 1 } }
    }
  });

  document.getElementById("downloadComparisonChart").onclick = () => {
    const a = document.createElement("a");
    a.download = "comparison_chart.png";
    a.href = activeComparisonChart.toBase64Image();
    a.click();
  };
}



// =====================================================================
// =========================  IMAGE VIEWER  =============================
// =====================================================================

async function setupImageViewer(rowData) {

  const filename = rowData["Filename"];
  if (!filename) return;

  // Show clicked image
  $("#recordImage").attr("src", "pages/" + filename);

  // Build ordered list of all filenames from BOTH catalogues
  // preserving their actual CSV order
  const allFiles = unifiedDataset
      .map(r => r.Filename)
      .filter(f => f && f.trim() !== "");

  // Find index of the current image
  let idx = allFiles.indexOf(filename);
  if (idx === -1) idx = 0;

  // Open viewer
  $("#recordImage").on("click", function() {

    const overlay = document.createElement("div");
    overlay.id = "overlayImageViewer";
    overlay.style = `
      position: fixed; inset: 0; background: rgba(0,0,0,0.92);
      display: flex; align-items: center; justify-content: center;
      z-index: 99999;
    `;

    overlay.innerHTML = `
      <img id="overlayImg" src="pages/${allFiles[idx]}" 
           style="max-width:90%; max-height:90%; border-radius:10px;">
      <button id="prevImg" class="btn btn-light position-absolute top-50 start-0 ms-3">‚ü®</button>
      <button id="nextImg" class="btn btn-light position-absolute top-50 end-0 me-3">‚ü©</button>
    `;

    document.body.appendChild(overlay);

    function update() {
      document.getElementById("overlayImg").src = "pages/" + allFiles[idx];
    }

    document.getElementById("prevImg").onclick = (e) => {
      e.stopPropagation();
      idx = (idx - 1 + allFiles.length) % allFiles.length;
      update();
    };

    document.getElementById("nextImg").onclick = (e) => {
      e.stopPropagation();
      idx = (idx + 1) % allFiles.length;
      update();
    };

    overlay.onclick = (e) => {
      if (e.target.id === "overlayImageViewer") overlay.remove();
    };

    document.addEventListener("keydown", function handler(e) {
      if (!document.body.contains(overlay)) {
        document.removeEventListener("keydown", handler);
        return;
      }
      if (e.key === "Escape") overlay.remove();
      if (e.key === "ArrowLeft") document.getElementById("prevImg").click();
      if (e.key === "ArrowRight") document.getElementById("nextImg").click();
    });
  });
}

</script>
<script>
// ==========================================================
// ===============   SCHEMA + HARMFUL MODULE   ==============
// ==========================================================

const SCHEMA_GROUPS = {
  "Identification": [
    "object_number", "secondary_identifier", "whole_or_part",
    "item_count", "collection", "legal_status", "location"
  ],
  "Object & Description": [
    "object_name", "description", "materials", "hazards", "measurements"
  ],
  "Place & Date": [
    "place_made", "date_made"
  ],
  "People": [
    "makers_and_associated_people"
  ],
  "Interpretation": [
    "interpretation", "interpretation_source", "interpretation_date"
  ]
};

let schemaPresenceChart = null;
let schemaQuantityChart = null;


// ----------------------------------------------------------
// BUILD SCHEMA + HARMFUL OUTDATED LANGUAGE COMPOSITE MODULE
// ----------------------------------------------------------
function buildSchemaAndHarmModule(cat, rowIndex) {

  const schema = schemaLookup[cat][rowIndex] || null;

  let html = `
    <div class="panel mt-4">
      <h5>üìë Extracted Schema Fields (AI-Enhanced)</h5>
      <div class="row">
        <div class="col-lg-4 border-end">
          <h6 class="text-muted small text-uppercase mb-3">Entity Counts</h6>
          ${buildSchemaCountsTable(schema)}
        </div>
        <div class="col-lg-8">
          ${buildSchemaAccordion(schema)}
        </div>
      </div>
    </div>

    <div class="panel mt-4">
      <h5 class="text-center">üìä Schema Entity Analysis</h5>

      <div id="schemaPresenceContainer" class="mb-4">
        <canvas id="schemaPresenceChart"></canvas>
        <button id="downloadSchemaPresence" class="btn btn-outline-secondary btn-sm mt-2">
          ‚¨áÔ∏è Download Presence Chart
        </button>
      </div>

      <div id="schemaQuantityContainer">
        <canvas id="schemaQuantityChart"></canvas>
        <button id="downloadSchemaQuantity" class="btn btn-outline-secondary btn-sm mt-2">
          ‚¨áÔ∏è Download Quantity Chart
        </button>
      </div>
    </div>

    ${buildHarmfulLanguageBlock(schema)}
  `;

  $("#schemaAndHarm").html(html);

  // After DOM injection ‚Üí draw spider charts
  buildSchemaCharts(schema);
}


// ----------------------------------------------------------
// SCHEMA COUNTS TABLE
// ----------------------------------------------------------
function buildSchemaCountsTable(schema) {
  if (!schema) return "<p class='text-muted fst-italic'>No schema available.</p>";

  let table = `<table class="count-table">`;

  for (const [group, fields] of Object.entries(SCHEMA_GROUPS)) {
    fields.forEach(f => {
      const v = schema[f];
      const c = countValue(v);
      const display = f.replace(/_/g, " ").replace(/^\w/, c => c.toUpperCase());
      table += `
        <tr>
          <td>${display}</td>
          <td class="text-end"><span class="count-badge">${c}</span></td>
        </tr>
      `;
    });
  }

  table += `</table>`;
  return table;
}


// ----------------------------------------------------------
// SCHEMA ACCORDION EXPANDERS
// ----------------------------------------------------------
function buildSchemaAccordion(schema) {
  if (!schema) return "<p class='text-muted fst-italic'>No schema available.</p>";

  let acc = ``;
  let i = 0;

  for (const [group, fields] of Object.entries(SCHEMA_GROUPS)) {
    i++;
    const id = `schemaAcc_${i}`;

    acc += `
    <div class="accordion mb-3" id="acc_${id}">
      <div class="accordion-item">
        <h2 class="accordion-header" id="h_${id}">
          <button class="accordion-button collapsed" type="button"
                  data-bs-toggle="collapse" data-bs-target="#${id}">
            ${group}
          </button>
        </h2>

        <div id="${id}" class="accordion-collapse collapse">
          <div class="accordion-body">
    `;

    fields.forEach(f => {
      let v = schema[f] || "";
      let parsed = safeParse(v);

      if (parsed !== null) {
        v = JSON.stringify(parsed, null, 2);
      }

      acc += `
      <div class="schema-field-row">
        <strong>${f}</strong>
        <span style="white-space:pre-wrap;">${v}</span>
      </div>`;
    });

    acc += `
          </div>
        </div>
      </div>
    </div>
    `;
  }

  return acc;
}


// ----------------------------------------------------------
// SCHEMA SPIDER CHARTS
// ----------------------------------------------------------
function buildSchemaCharts(schema) {
  if (!schema) return;

  const fields = Object.values(SCHEMA_GROUPS).flat();

  const presence = fields.map(f => {
    const v = schema[f];
    if (!v) return 0;
    const s = String(v).trim();
    return (s && s !== "" && s.toLowerCase() !== "nan") ? 1 : 0;
  });

  const quantities = fields.map(f => countValue(schema[f]));

  const maxQ = Math.max(...quantities, 1);

  const ctxP = document.getElementById("schemaPresenceChart");
  const ctxQ = document.getElementById("schemaQuantityChart");

  if (schemaPresenceChart) schemaPresenceChart.destroy();
  if (schemaQuantityChart) schemaQuantityChart.destroy();

  schemaPresenceChart = new Chart(ctxP, {
    type: "radar",
    data: {
      labels: fields,
      datasets: [{
        label: "Presence (1 = present)",
        data: presence,
        backgroundColor: "rgba(46,204,113,0.25)",
        borderColor: "rgba(46,204,113,1)"
      }]
    },
    options: { scales: { r: { beginAtZero: true, max: 1 } } }
  });

  schemaQuantityChart = new Chart(ctxQ, {
    type: "radar",
    data: {
      labels: fields,
      datasets: [{
        label: "Quantity (# values)",
        data: quantities,
        backgroundColor: "rgba(155,89,182,0.25)",
        borderColor: "rgba(155,89,182,1)"
      }]
    },
    options: { scales: { r: { beginAtZero: true, max: maxQ + 1 } } }
  });

  // Download buttons
  $("#downloadSchemaPresence").on("click", () => {
    const a = document.createElement("a");
    a.download = "schema_presence_chart.png";
    a.href = schemaPresenceChart.toBase64Image();
    a.click();
  });

  $("#downloadSchemaQuantity").on("click", () => {
    const a = document.createElement("a");
    a.download = "schema_quantity_chart.png";
    a.href = schemaQuantityChart.toBase64Image();
    a.click();
  });
}


// ----------------------------------------------------------
// HARMFUL / OUTDATED LANGUAGE MODULE
// ----------------------------------------------------------
function buildHarmfulLanguageBlock(schemaRow) {

  if (!schemaRow) {
    return `
      <div class="panel mt-4">
        <h5>‚ö†Ô∏è Harmful / Outdated Language</h5>
        <p class="text-muted fst-italic">No schema information for this record.</p>
      </div>`;
  }

  // Parse row-level values
  const harmful = safeParse(schemaRow.harmful_language) || {count:0, terms:[]};
  const outdated = safeParse(schemaRow.outdated_language) || {count:0, terms:[]};

  return `
  <div class="panel mt-4">
    <h5>‚ö†Ô∏è Harmful & Outdated Language</h5>

    <p class="text-muted mb-2">
      Counts below are calculated for this record.  
      Total project-wide counts are also included.
    </p>

    <!-- Per-record harmful language -->
    <div class="harm-block">
      <h6>üö´ Harmful Language</h6>
      <p><b>Record count:</b> ${harmful.count}</p>
      <p><b>Terms:</b> ${harmful.terms.length ? harmful.terms.join(", ") : "None"}</p>
      <hr>
      <p><b>Total (All Catalogues):</b> ${harmfulTotals.harmful}</p>
      <p><b>All Terms (Project Total):</b> ${[...new Set(harmfulTotals.harmfulTerms)].join(", ") || "None"}</p>
    </div>

    <!-- Per-record outdated language -->
    <div class="outdated-block">
      <h6>‚è≥ Outdated Language</h6>
      <p><b>Record count:</b> ${outdated.count}</p>
      <p><b>Terms:</b> ${outdated.terms.length ? outdated.terms.join(", ") : "None"}</p>
      <hr>
      <p><b>Total (All Catalogues):</b> ${harmfulTotals.outdated}</p>
      <p><b>All Terms (Project Total):</b> ${[...new Set(harmfulTotals.outdatedTerms)].join(", ") || "None"}</p>
    </div>
  </div>
  `;
}


// ----------------------------------------------------------
// HOOK SCHEMA MODULE INTO MODAL
// Called at end of modal build in Chunk 4
// ----------------------------------------------------------
function buildSchemaAndHarm(cat, rowIndex) {
  buildSchemaAndHarmModule(cat, rowIndex);
}

// Overwrite placeholder in Chunk 4 (openRecordModal)
const _openRecordModal_original = openRecordModal;
openRecordModal = function(rowData) {
  _openRecordModal_original(rowData);
  buildSchemaAndHarm(rowData.__cat, rowData.__rowIndex);
};
</script>
</body>
</html>
