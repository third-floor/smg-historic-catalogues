<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Museum Object Record Comparator ‚Äî Multi-Catalogue Edition</title>

  <!-- Bootstrap + DataTables CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      background-color: #fafafa;
      font-family: 'Inter', sans-serif;
      margin: 1.5rem;
    }

    h1 {
      text-align: center;
      margin-bottom: 1rem;
      font-weight: 600;
    }

    .dual-panel {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
    }

    .panel {
      flex: 1 1 45%;
      background: #fff;
      border-radius: 10px;
      padding: 1.2rem;
      box-shadow: 0 0 8px rgba(0,0,0,0.05);
      min-width: 280px;
    }

    .field-row {
      border-bottom: 1px dashed #eee;
      padding: .25rem 0;
      font-size: .95rem;
      display: flex;
      justify-content: space-between;
    }

    .catalogue-badge {
      padding: 3px 8px;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
      color: #fff;
    }

    footer {
      text-align: center;
      font-size: .9rem;
      margin-top: 2rem;
      color: #777;
    }

    @media (max-width: 768px) {
      .dual-panel { flex-direction: column; }
      .panel { flex: 1 1 100%; }
    }

    /* Harmful + outdated blocks */
    .harm-block {
      background: #fff5f5;
      border: 1px solid #ffcccc;
      padding: 1rem;
      border-radius: 8px;
    }
    .outdated-block {
      background: #fffdf2;
      border: 1px solid #f5e7a1;
      padding: 1rem;
      border-radius: 8px;
    }
    /* Horizontally scrollable catalogue button bar */
    #catalogueButtonContainer {
      overflow-x: auto;
      white-space: nowrap;
      padding-bottom: .5rem;
    }

    #catalogueButtonContainer .btn-group {
      flex-wrap: nowrap;
      white-space: nowrap;
    }
  </style>
</head>

<body>
<div class="container">

  <h1>üß≠ Museum Object Record Comparator ‚Äî Multi-Catalogue Edition</h1>

  <p class="text-center text-muted mb-3">
    Compare any number of catalogues with unified search, schema insights, and harmful/outdated language analysis.
  </p>

  <!-- AUTO-GENERATED BUTTONS -->
  <div id="catalogueButtonContainer" class="mb-3"></div>

  <!-- GLOBAL SEARCH BAR -->
  <div class="mb-3 d-flex justify-content-center">
    <input type="text" id="globalSearch" class="form-control w-50" placeholder="üîç Search all records...">
  </div>

  <!-- MAIN TABLE -->
  <div class="table-responsive">
    <table id="recordsTable" class="table table-striped table-hover" style="width:100%">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>

  <footer>Built on the third-floor.</footer>
</div>

<!-- ===================== -->
<!-- REQUIRED JS LIBRARIES -->
<!-- ===================== -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
// =====================================================================================
// CONFIG ‚Äî How many catalogues do you have?
// =====================================================================================
const TOTAL_CATALOGUES = 6;

// =====================================================================================
// GLOBAL DATA STORAGE
// =====================================================================================
let catalogues = {};
let comparisons = {};
let schemas = {};

let unifiedDataset = [];
let comparisonLookup = {};
let schemaLookup = {};

let harmfulTotals = {
  harmful: 0,
  harmfulTerms: [],
  outdated: 0,
  outdatedTerms: []
};

// =====================================================================================
// SAFE JSON PARSER
// =====================================================================================
function safeParse(val) {
  if (!val) return null;
  val = String(val).trim();
  try { return JSON.parse(val); } catch(e) {}

  try {
    let fixed = val
      .replace(/'/g, '"')
      .replace(/\bNone\b/g, 'null')
      .replace(/\bTrue\b/g, 'true')
      .replace(/\bFalse\b/g, 'false');
    return JSON.parse(fixed);
  } catch(err) { return null; }
}

function countValue(val) {
  if (!val) return 0;
  const parsed = safeParse(val);
  if (Array.isArray(parsed)) return parsed.length;
  if (typeof parsed === "object" && parsed !== null) return 1;
  return 1;
}

// =====================================================================================
// CSV LOADER
// =====================================================================================
function loadCSV(path) {
  return new Promise(resolve => {
    Papa.parse(path, {
      download: true,
      header: true,
      complete: res => {
        const cleaned = res.data.filter(r =>
          Object.values(r).some(v => v !== "" && v !== null && v !== undefined)
        );
        resolve(cleaned);
      }
    });
  });
}

// =====================================================================================
// LOAD ALL CATALOGUES + BUILD UNIFIED DATASET w/ SEARCH INDEX
// =====================================================================================
async function loadAllCatalogues() {
  for (let i = 1; i <= TOTAL_CATALOGUES; i++) {

    const [cat, comp, sch] = await Promise.all([
      loadCSV(`matched_records_${i}.csv`),
      loadCSV(`entity_comparison_results_${i}.csv`),
      loadCSV(`schema_extraction_${i}.csv`)
    ]);

    catalogues[i] = cat;
    comparisons[i] = comp;
    schemas[i] = sch;

    comparisonLookup[i] = {};
    comp.forEach(r => {
      const idx = Number(r.RowIndex);
      if (!isNaN(idx)) comparisonLookup[i][idx] = r;
    });

    schemaLookup[i] = {};
    sch.forEach(r => {
      const idx = Number(r.RowIndex);
      if (!isNaN(idx)) schemaLookup[i][idx] = r;
    });

    // Build unified rows WITH SEARCH INDEX
    cat.forEach((row, idx) => {

      const searchableFields = [
        row["Catalogue number"],
        row["Object name"],
        row["Object/Inventory number"],
        row["uid"],
        row["identifier"],
        row["title"],
        row["description"],
        row["Maker/Donor"],
        row["Date of creation"],
        row["material"],
        row["place"],
        row["object_name"]
      ]
      .filter(Boolean)
      .join(" ")
      .toLowerCase();

      unifiedDataset.push({
        ...row,
        __cat: String(i),
        __rowIndex: idx,
        __search: searchableFields   // üî• COMPLETE SEARCH INDEX
      });
    });

    // Harmful totals
    sch.forEach(r => {
      const h = safeParse(r.harmful_language);
      const o = safeParse(r.outdated_language);

      if (h && h.count) {
        harmfulTotals.harmful += h.count;
        harmfulTotals.harmfulTerms.push(...h.terms);
      }
      if (o && o.count) {
        harmfulTotals.outdated += o.count;
        harmfulTotals.outdatedTerms.push(...o.terms);
      }
    });
  }
}

// =====================================================================================
// AUTO-GENERATED CATALOGUE BUTTONS
// =====================================================================================
function buildCatalogueButtons() {
  const container = document.getElementById("catalogueButtonContainer");

  // Use d-inline-flex so the button group grows horizontally without wrapping
  let html = `<div class="btn-group d-inline-flex" role="group">`;

  for (let i = 1; i <= TOTAL_CATALOGUES; i++) {
    html += `
      <input type="radio" class="btn-check" name="catalogueSelect" id="cat${i}" value="${i}">
      <label class="btn btn-outline-primary" for="cat${i}">Catalogue ${i}</label>
    `;
  }

  // Add "All" at the end
  html += `
    <input type="radio" class="btn-check" name="catalogueSelect" id="catAll" value="All" checked>
    <label class="btn btn-outline-primary" for="catAll">All</label>
  </div>
  `;

  container.innerHTML = html;
}

// =====================================================================================
// DATATABLE INITIALISATION (NOW INCLUDES HIDDEN SEARCH INDEX COLUMN)
// =====================================================================================
let recordsTable = null;

const VISIBLE_COLS = [
  "Catalogue number",
  "Object name",
  "Object/Inventory number",
  "uid",
  "identifier",
  "title"
];

function createDataTable() {
  const sample = unifiedDataset[0] || {};

  const columns = [];

  // Catalogue
  columns.push({
    title: "Catalogue",
    data: "__cat",
    render: c => `<span class="catalogue-badge" style="background:#007bff">${c}</span>`
  });

  // Visible fields
  VISIBLE_COLS.forEach(col => {
    if (col in sample) {
      columns.push({
        title: col,
        data: col
      });
    }
  });

  // üî• Hidden search index field
  columns.push({
    title: "Search Index",
    data: "__search",
    visible: false,
    searchable: true
  });

  recordsTable = $("#recordsTable").DataTable({
    data: unifiedDataset,
    columns,
    pageLength: 25,
    responsive: true
  });
}

// =====================================================================================
// FILTER + SEARCH
// =====================================================================================
function setupCatalogueFiltering() {
  $(document).on("change", "input[name='catalogueSelect']", function() {
    const val = this.value;
    if (val !== "All") {
      recordsTable.column(0).search("^" + val + "$", true, false).draw();
    } else {
      recordsTable.column(0).search("").draw();
    }
  });
}

function setupSearchBar() {
  $("#globalSearch").on("keyup", function() {
    recordsTable.search(this.value.toLowerCase()).draw();
  });
}

// =====================================================================================
// THE ENTIRE MODAL / SCHEMA / IMAGE VIEWER SYSTEM
// (Unmodified except for __cat now being numeric)
// =====================================================================================
let activeComparisonChart=null;

$(document).on("click","#recordsTable tbody tr",function(){
  const data=recordsTable.row(this).data();
  if(data) openRecordModal(data);
});

function openRecordModal(rowData){
  const cat=Number(rowData.__cat);
  const idx=rowData.__rowIndex;

  const comp=comparisonLookup[cat][idx]||null;

  $("#recordModal").remove();
  buildModalShell();
  fillLeftRightPanels(rowData);
  fillUniqueSections(comp);
  buildComparisonChart(comp);
  setupImageViewer(rowData);
  buildSchemaAndHarmModule(cat,idx);

  new bootstrap.Modal(document.getElementById("recordModal")).show();
}

function buildModalShell() {
  document.body.insertAdjacentHTML("beforeend",`
  <div class="modal fade" id="recordModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">üîé Record Details</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">

          <div id="comparisonChartContainer" class="text-center mb-4">
            <canvas id="comparisonChart" style="max-width:600px;"></canvas>
            <button id="downloadComparisonChart" class="btn btn-outline-secondary btn-sm mt-2">‚¨áÔ∏è Download Comparison Chart</button>
          </div>

          <div id="dualPanels" class="dual-panel mb-4"></div>

          <div class="dual-panel mb-4">
            <div class="panel"><h6>üåø Unique to Catalogue</h6><div id="uniqueA"></div></div>
            <div class="panel"><h6>üè∫ Unique to Online</h6><div id="uniqueB"></div></div>
          </div>

          <div id="schemaAndHarm"></div>

          <div class="mt-4 text-center">
            <h6>üñºÔ∏è Related Image</h6>
            <img id="recordImage" src="" class="img-fluid rounded shadow-sm" style="max-height:420px; cursor:pointer;">
          </div>

        </div>
      </div>
    </div>
  </div>
  `);
}

const LEFT_FIELDS=[
  "Filename","Catalogue number","Object name","Maker/Donor",
  "Date of creation","Object entry information","Object/Inventory number"
];

const RIGHT_FIELDS=[
  "uid","identifier","title","description","category",
  "material","object_name","date","place","maker","image"
];

function fillLeftRightPanels(r){
  let L=`<div class="panel"><h5>üìò Catalogue ${r.__cat}</h5>`;
  LEFT_FIELDS.forEach(f=>L+=`<div class="field-row"><strong>${f}</strong><span>${r[f]||""}</span></div>`);
  L+=`</div>`;

  let R=`<div class="panel"><h5>üèõÔ∏è Online Record</h5>`;
  RIGHT_FIELDS.forEach(f=>{
    let v=r[f]||"";
    if(f==="uid"&&v) v=`<a href="https://collection.sciencemuseumgroup.org.uk/objects/${v}" target="_blank">${v}</a>`;
    if(f==="image"&&v) v=`<a href="https://coimages.sciencemuseumgroup.org.uk/${v}" target="_blank">View image üîó</a>`;
    R+=`<div class="field-row"><strong>${f}</strong><span>${v}</span></div>`;
  });
  R+=`</div>`;

  $("#dualPanels").html(L+R);
}

function makeUniqueBlock(str){
  if(!str) return "<p class='text-muted'>None</p>";
  try{
    const obj=JSON.parse(str);
    return Object.entries(obj)
      .filter(([k,v])=>Array.isArray(v)&&v.length)
      .map(([k,v])=>`<div><strong>${k}:</strong> ${v.join(", ")}</div>`)
      .join("") || "<p class='text-muted'>None</p>";
  } catch { return "<p class='text-muted'>None</p>"; }
}

function fillUniqueSections(c){
  $("#uniqueA").html(makeUniqueBlock(c?.Unique_to_Old));
  $("#uniqueB").html(makeUniqueBlock(c?.Unique_to_New));
}

const METRIC_LABELS=[
  "ObjectNames","Makers","Organisations/Institutions",
  "Dates","Places","Descriptions","Other"
];

function buildComparisonChart(c){
  if(!c) return;
  const oldVals=METRIC_LABELS.map(m=>Number(c["Old_"+m]||0));
  const newVals=METRIC_LABELS.map(m=>Number(c["New_"+m]||0));
  const maxVal=Math.max(...oldVals,...newVals,1);

  const ctx=document.getElementById("comparisonChart");
  if(activeComparisonChart) activeComparisonChart.destroy();

  activeComparisonChart=new Chart(ctx,{
    type:"radar",
    data:{
      labels:METRIC_LABELS,
      datasets:[
        {label:"Catalogue",data:oldVals,backgroundColor:"rgba(54,162,235,.25)",borderColor:"blue"},
        {label:"Online",data:newVals,backgroundColor:"rgba(255,99,132,.25)",borderColor:"red"}
      ]
    },
    options:{scales:{r:{beginAtZero:true,max:maxVal+1}}}
  });

  document.getElementById("downloadComparisonChart").onclick=()=>{
    const a=document.createElement("a");
    a.download="comparison_chart.png";
    a.href=activeComparisonChart.toBase64Image();
    a.click();
  };
}

async function setupImageViewer(rowData){
  const file=rowData["Filename"];
  if(!file) return;

  $("#recordImage").attr("src","pages/"+file);

  const all=unifiedDataset.map(r=>r.Filename).filter(Boolean);
  let idx=all.indexOf(file);

  $("#recordImage").on("click",function(){
    const overlay=document.createElement("div");
    overlay.id="overlayImageViewer";
    overlay.style=`
      position:fixed; inset:0; background:rgba(0,0,0,.92);
      display:flex; align-items:center; justify-content:center; z-index:99999;
    `;
    overlay.innerHTML=`
      <img id="overlayImg" src="pages/${all[idx]}" style="max-width:90%; max-height:90%;">
      <button id="prevImg" class="btn btn-light position-absolute top-50 start-0 ms-3">‚ü®</button>
      <button id="nextImg" class="btn btn-light position-absolute top-50 end-0 me-3">‚ü©</button>
    `;
    document.body.appendChild(overlay);

    function update(){ document.getElementById("overlayImg").src="pages/"+all[idx]; }

    document.getElementById("prevImg").onclick=e=>{e.stopPropagation(); idx=(idx-1+all.length)%all.length; update();};
    document.getElementById("nextImg").onclick=e=>{e.stopPropagation(); idx=(idx+1)%all.length; update();};

    overlay.onclick=e=>{ if(e.target.id==="overlayImageViewer") overlay.remove(); };

    document.addEventListener("keydown",function handler(e){
      if(!document.body.contains(overlay)){document.removeEventListener("keydown",handler);return;}
      if(e.key==="Escape") overlay.remove();
      if(e.key==="ArrowLeft") document.getElementById("prevImg").click();
      if(e.key==="ArrowRight") document.getElementById("nextImg").click();
    });
  });
}

// =====================================================================================
// SCHEMA + HARMFUL LANGUAGE MODULE
// =====================================================================================
const SCHEMA_GROUPS={
  "Identification":[
    "object_number","secondary_identifier","whole_or_part",
    "item_count","collection","legal_status","location"
  ],
  "Object & Description":[
    "object_name","description","materials","hazards","measurements"
  ],
  "Place & Date":["place_made","date_made"],
  "People":["makers_and_associated_people"],
  "Interpretation":[
    "interpretation","interpretation_source","interpretation_date"
  ]
};

let schemaPresenceChart=null;
let schemaQuantityChart=null;

function buildSchemaAndHarmModule(cat,idx){
  const schema=schemaLookup[cat][idx]||null;

  let html=`
    <div class="panel mt-4">
      <h5>üìë Extracted Schema Fields</h5>
      <div class="row">
        <div class="col-lg-4 border-end">${buildSchemaCounts(schema)}</div>
        <div class="col-lg-8">${buildSchemaAccordion(schema)}</div>
      </div>
    </div>

    <div class="panel mt-4">
      <h5 class="text-center">üìä Schema Entity Analysis</h5>
      <canvas id="schemaPresenceChart" class="mb-3"></canvas>
      <button id="downloadSchemaPresence" class="btn btn-outline-secondary btn-sm mb-4">‚¨áÔ∏è Download Presence Chart</button>

      <canvas id="schemaQuantityChart" class="mb-3"></canvas>
      <button id="downloadSchemaQuantity" class="btn btn-outline-secondary btn-sm">‚¨áÔ∏è Download Quantity Chart</button>
    </div>

    ${buildHarm(schema)}
  `;

  $("#schemaAndHarm").html(html);
  buildSchemaCharts(schema);
}

function buildSchemaCounts(s){
  if(!s) return "<p class='text-muted'>No schema.</p>";
  let html="<table>";
  for(const [grp,fields] of Object.entries(SCHEMA_GROUPS)){
    fields.forEach(f=>{
      html+=`
        <tr>
          <td>${f.replace(/_/g," ")}</td>
          <td class="text-end">${countValue(s[f])}</td>
        </tr>`;
    });
  }
  return html+"</table>";
}

function buildSchemaAccordion(s){
  if(!s) return "<p class='text-muted'>No schema.</p>";
  let html="",n=0;
  for(const [grp,fields] of Object.entries(SCHEMA_GROUPS)){
    n++;
    html+=`
    <div class="accordion mb-3" id="acc_${n}">
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#c_${n}">
            ${grp}
          </button>
        </h2>
        <div id="c_${n}" class="accordion-collapse collapse">
          <div class="accordion-body">`;
    fields.forEach(f=>{
      let v=s[f]||"";
      let p=safeParse(v);
      if(p!==null) v=JSON.stringify(p,null,2);
      html+=`<div class="schema-field-row"><strong>${f}</strong><pre>${v}</pre></div>`;
    });
    html+=`
          </div>
        </div>
      </div>
    </div>`;
  }
  return html;
}

function buildSchemaCharts(s){
  if(!s) return;

  const fields=Object.values(SCHEMA_GROUPS).flat();
  const presence=fields.map(f=>s[f]?1:0);
  const quantities=fields.map(f=>countValue(s[f]));
  const maxQ=Math.max(...quantities,1);

  if(schemaPresenceChart) schemaPresenceChart.destroy();
  if(schemaQuantityChart) schemaQuantityChart.destroy();

  schemaPresenceChart=new Chart(document.getElementById("schemaPresenceChart"),{
    type:"radar",
    data:{labels:fields,datasets:[{
      label:"Presence",data:presence,
      backgroundColor:"rgba(46,204,113,.25)",borderColor:"green"
    }]},
    options:{scales:{r:{beginAtZero:true,max:1}}}
  });

  schemaQuantityChart=new Chart(document.getElementById("schemaQuantityChart"),{
    type:"radar",
    data:{labels:fields,datasets:[{
      label:"Quantity",data:quantities,
      backgroundColor:"rgba(155,89,182,.25)",borderColor:"purple"
    }]},
    options:{scales:{r:{beginAtZero:true,max:maxQ+1}}}
  });

  $("#downloadSchemaPresence").on("click",()=>downloadChart(schemaPresenceChart,"schema_presence.png"));
  $("#downloadSchemaQuantity").on("click",()=>downloadChart(schemaQuantityChart,"schema_quantity.png"));
}

function downloadChart(chart,name){
  const a=document.createElement("a");
  a.download=name;
  a.href=chart.toBase64Image();
  a.click();
}

function buildHarm(s){
  if(!s) return `<div class="panel mt-4"><h5>‚ö†Ô∏è Harmful / Outdated Language</h5><p>No schema.</p></div>`;
  const harmful=safeParse(s.harmful_language)||{count:0,terms:[]};
  const outdated=safeParse(s.outdated_language)||{count:0,terms:[]};

  return `
  <div class="panel mt-4">
    <h5>‚ö†Ô∏è Harmful & Outdated Language</h5>

    <div class="harm-block mb-3">
      <h6>üö´ Harmful</h6>
      <p><b>Record count:</b> ${harmful.count}</p>
      <p><b>Terms:</b> ${harmful.terms.join(", ")||"None"}</p>
      <hr>
      <p><b>Total project count:</b> ${harmfulTotals.harmful}</p>
    </div>

    <div class="outdated-block">
      <h6>‚è≥ Outdated</h6>
      <p><b>Record count:</b> ${outdated.count}</p>
      <p><b>Terms:</b> ${outdated.terms.join(", ")||"None"}</p>
      <hr>
      <p><b>Total project count:</b> ${harmfulTotals.outdated}</p>
    </div>
  </div>`;
}

// =====================================================================================
// INITIALISE EVERYTHING
// =====================================================================================
document.addEventListener("DOMContentLoaded", async () => {
  await loadAllCatalogues();
  buildCatalogueButtons();
  createDataTable();
  setupCatalogueFiltering();
  setupSearchBar();
});
</script>
</body>
</html>
